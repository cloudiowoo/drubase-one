<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaaS Realtime WebSocket æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.connected { background-color: #d4edda; color: #155724; }
        .status.disconnected { background-color: #f8d7da; color: #721c24; }
        .status.connecting { background-color: #fff3cd; color: #856404; }
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background: white;
        }
        .message.notification {
            border-left-color: #28a745;
            background-color: #f0fff4;
        }
        .message.error {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        h1 { color: #333; }
        h2 { color: #666; }
        .timestamp { color: #666; font-size: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ BaaS Realtime WebSocket æµ‹è¯•</h1>
        
        <div id="status" class="status disconnected">âŒ æœªè¿æ¥</div>
        
        <div class="controls">
            <h2>è¿æ¥é…ç½®</h2>
            <input type="text" id="tenantId" placeholder="Tenant ID" value="tenant_7375b0cd">
            <input type="text" id="projectId" placeholder="Project ID" value="tenant_7375b0cd_project_6888d012be80c">
            <input type="text" id="apikey" placeholder="API Key" value="drubase_e5452c4f0b8d5c1011016b12bddd1165136b6520f99479bc9a171fe767830275">
            <input type="text" id="accessToken" placeholder="Access Token" value="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxNyIsInVzZXJuYW1lIjoidXNlcjEiLCJ0ZW5hbnRfaWQiOiJ0ZW5hbnRfNzM3NWIwY2QiLCJhY2Nlc3NfdHlwZSI6InRlbmFudCIsImlzcyI6ImRydWJhc2UiLCJhdWQiOiJkcnViYXNlLWFwaSIsImlhdCI6MTc1NDQ4ODE0OSwiZXhwIjoxNzg2MDI0MTQ5LCJqdGkiOiIwYjg5ZWVmZTEzNGY0ZjM0ZDhlMTU3MmY2YmQ3ZjBmZSIsInR5cGUiOiJhY2Nlc3MifQ.E6CsN8dJBr2Kg98NLlsOmnAtvKgX5S_JuArl0YfrvGg">
            <br>
            <button onclick="connect()">ğŸ”Œ è¿æ¥</button>
            <button onclick="disconnect()">âŒ æ–­å¼€</button>
            <button onclick="subscribe()">ğŸ“¡ è®¢é˜…é¢‘é“</button>
            <button onclick="clearMessages()">ğŸ§¹ æ¸…ç©ºæ¶ˆæ¯</button>
        </div>
        
        <div class="controls">
            <h2>æµ‹è¯•æ“ä½œ</h2>
            <button onclick="testAuth()">ğŸ” æµ‹è¯•è®¤è¯API</button>
            <button onclick="testInsert()">ğŸ“ æµ‹è¯•æ’å…¥</button>
            <button onclick="testUpdate()">âœï¸ æµ‹è¯•æ›´æ–°</button>  
            <button onclick="testDelete()">ğŸ—‘ï¸ æµ‹è¯•åˆ é™¤</button>
        </div>
        
        <h2>ğŸ“¨ æ¶ˆæ¯æ—¥å¿—</h2>
        <div id="messages" class="messages"></div>
    </div>

    <script>
        let ws = null;
        let connectionId = null;
        
        function log(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `
                <div class="timestamp">[${timestamp}]</div>
                <div>${message}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateStatus(status, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = message;
        }
        
        async function connect() {
            const tenantId = document.getElementById('tenantId').value;
            const projectId = document.getElementById('projectId').value;
            const apikey = document.getElementById('apikey').value;
            const accessToken = document.getElementById('accessToken').value;
            
            if (!tenantId || !projectId || !apikey || !accessToken) {
                alert('è¯·å¡«å†™ Tenant IDã€Project IDã€API Key å’Œ Access Token');
                return;
            }
            
            if (ws) {
                ws.close();
            }
            
            updateStatus('connecting', 'ğŸ”„ è®¤è¯ä¸­...');
            log('å¼€å§‹è®¤è¯ WebSocket è¿æ¥...', 'info');
            
            try {
                // ç¬¬ä¸€æ­¥ï¼šé€šè¿‡ Drupal API è¿›è¡Œè®¤è¯
                const authUrl = `http://localhost/api/v1/${tenantId}/projects/${projectId}/realtime/auth`;
                log(`è®¤è¯URL: ${authUrl}`, 'info');
                
                const authResponse = await fetch(authUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'X-API-Key': apikey
                    },
                    body: JSON.stringify({
                        access_token: accessToken,
                        apikey: apikey
                    })
                });
                
                if (!authResponse.ok) {
                    const errorText = await authResponse.text();
                    log(`è®¤è¯å¤±è´¥: ${authResponse.status} - ${errorText}`, 'error');
                    updateStatus('disconnected', 'âŒ è®¤è¯å¤±è´¥');
                    return;
                }
                
                const authData = await authResponse.json();
                log(`è®¤è¯å“åº”: ${JSON.stringify(authData, null, 2)}`, 'info');
                
                if (!authData.success) {
                    log(`è®¤è¯å¤±è´¥: ${authData.error}`, 'error');
                    updateStatus('disconnected', 'âŒ è®¤è¯å¤±è´¥');
                    return;
                }
                
                log('âœ… è®¤è¯æˆåŠŸï¼Œå»ºç«‹ WebSocket è¿æ¥...', 'info');
                updateStatus('connecting', 'ğŸ”„ è¿æ¥ä¸­...');
                
                // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨è®¤è¯ä¿¡æ¯å»ºç«‹ WebSocket è¿æ¥
                const wsUrl = `ws://localhost:4000?tenant_id=${encodeURIComponent(tenantId)}&project_id=${encodeURIComponent(projectId)}&apikey=${encodeURIComponent(apikey)}&access_token=${encodeURIComponent(accessToken)}`;
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function(event) {
                    updateStatus('connected', 'âœ… å·²è¿æ¥');
                    log('WebSocket è¿æ¥å·²å»ºç«‹', 'info');
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data, null, 2)}`, 'notification');
                        
                        // å¤„ç†è¿æ¥ç¡®è®¤
                        if (data.event === 'phx_reply' && data.topic === 'phoenix') {
                            connectionId = data.payload?.response?.connection_id;
                            log(`è¿æ¥ID: ${connectionId}`, 'info');
                        }
                        
                        // å¤„ç†å®æ—¶é€šçŸ¥
                        if (data.event && data.payload) {
                            log(`ğŸ”” å®æ—¶é€šçŸ¥: ${data.event} - ${JSON.stringify(data.payload, null, 2)}`, 'notification');
                        }
                        
                    } catch (e) {
                        log(`åŸå§‹æ¶ˆæ¯: ${event.data}`, 'info');
                    }
                };
                
                ws.onclose = function(event) {
                    updateStatus('disconnected', 'âŒ è¿æ¥å·²æ–­å¼€');
                    log(`WebSocket è¿æ¥å…³é—­: ${event.code} - ${event.reason}`, 'error');
                    ws = null;
                    connectionId = null;
                };
                
                ws.onerror = function(error) {
                    updateStatus('disconnected', 'âŒ è¿æ¥é”™è¯¯');
                    log(`WebSocket é”™è¯¯: ${error}`, 'error');
                };
                
            } catch (error) {
                log(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus('disconnected', 'âŒ è¿æ¥å¤±è´¥');
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                connectionId = null;
                updateStatus('disconnected', 'âŒ å·²æ–­å¼€');
                log('æ‰‹åŠ¨æ–­å¼€è¿æ¥', 'info');
            }
        }
        
        function subscribe() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('è¯·å…ˆè¿æ¥ WebSocket');
                return;
            }
            
            // è®¢é˜… activities è¡¨çš„å˜æ›´
            const message = {
                event: 'phx_join',
                topic: 'table:baas_00403b_activities',
                payload: {
                    filters: {},
                    event_types: ['INSERT', 'UPDATE', 'DELETE']
                },
                ref: Date.now()
            };
            
            ws.send(JSON.stringify(message));
            log(`å‘é€è®¢é˜…æ¶ˆæ¯: ${JSON.stringify(message, null, 2)}`, 'info');
        }
        
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }
        
        // æµ‹è¯•è®¤è¯APIç«¯ç‚¹
        async function testAuth() {
            const tenantId = document.getElementById('tenantId').value;
            const projectId = document.getElementById('projectId').value;
            const apikey = document.getElementById('apikey').value;
            const accessToken = document.getElementById('accessToken').value;
            
            if (!tenantId || !projectId || !apikey || !accessToken) {
                alert('è¯·å¡«å†™ Tenant IDã€Project IDã€API Key å’Œ Access Token');
                return;
            }
            
            log('ğŸ” å¼€å§‹æµ‹è¯•è®¤è¯API...', 'info');
            
            try {
                const authUrl = `http://localhost/api/v1/${tenantId}/projects/${projectId}/realtime/auth`;
                log(`æµ‹è¯•è®¤è¯ç«¯ç‚¹: ${authUrl}`, 'info');
                
                const response = await fetch(authUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'X-API-Key': apikey
                    },
                    body: JSON.stringify({
                        access_token: accessToken,
                        apikey: apikey
                    })
                });
                
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = { raw_response: responseText };
                }
                
                log(`HTTPçŠ¶æ€ç : ${response.status} ${response.statusText}`, response.ok ? 'info' : 'error');
                log(`å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`, 'info');
                log(`å“åº”å†…å®¹: ${JSON.stringify(responseData, null, 2)}`, response.ok ? 'info' : 'error');
                
                if (response.ok && responseData.success) {
                    log('âœ… è®¤è¯APIæµ‹è¯•æˆåŠŸï¼', 'notification');
                    log(`ç”¨æˆ·ID: ${responseData.data?.user_id}`, 'info');
                    log(`ç§Ÿæˆ·ID: ${responseData.data?.tenant_id}`, 'info');
                    log(`é¡¹ç›®ID: ${responseData.data?.project_id}`, 'info');
                    log(`æƒé™: ${JSON.stringify(responseData.data?.permissions, null, 2)}`, 'info');
                } else {
                    log('âŒ è®¤è¯APIæµ‹è¯•å¤±è´¥', 'error');
                    if (responseData.error) {
                        log(`é”™è¯¯ä¿¡æ¯: ${responseData.error}`, 'error');
                        log(`é”™è¯¯ä»£ç : ${responseData.code}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`âŒ è®¤è¯APIæµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                console.error('è®¤è¯æµ‹è¯•é”™è¯¯:', error);
            }
        }
        
        // æµ‹è¯•æ•°æ®åº“æ“ä½œ
        function testInsert() {
            log('è§¦å‘æ’å…¥æ“ä½œ...', 'info');
            // è¿™é‡Œåº”è¯¥è°ƒç”¨ API æ¥æ’å…¥æ•°æ®ï¼Œä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬åªè®°å½•
            alert('è¯·åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ:\ndocker exec pg17 psql -U postgres -d db_drubase -c "INSERT INTO baas_00403b_activities (uuid, title, activity_date, activity_time, sport_type, team_count, players_per_team, creator_id, participants_visibility, created, updated) VALUES (\'test-\' || extract(epoch from now())::text, \'WebSocket Test Activity\', \'2024-01-01\', \'10:00\', \'football\', 2, 11, 17, \'public\', extract(epoch from now())::integer, extract(epoch from now())::integer);"');
        }
        
        function testUpdate() {
            log('è§¦å‘æ›´æ–°æ“ä½œ...', 'info');
            alert('è¯·åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ:\ndocker exec pg17 psql -U postgres -d db_drubase -c "UPDATE baas_00403b_activities SET title = \'Updated via WebSocket Test\', updated = extract(epoch from now())::integer WHERE uuid LIKE \'test-%\' LIMIT 1;"');
        }
        
        function testDelete() {
            log('è§¦å‘åˆ é™¤æ“ä½œ...', 'info');
            alert('è¯·åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ:\ndocker exec pg17 psql -U postgres -d db_drubase -c "DELETE FROM baas_00403b_activities WHERE uuid LIKE \'test-%\' LIMIT 1;"');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('BaaS Realtime WebSocket æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('è¯·å¡«å†™è®¤è¯ä¿¡æ¯å¹¶ç‚¹å‡»è¿æ¥', 'info');
        };
    </script>
</body>
</html>