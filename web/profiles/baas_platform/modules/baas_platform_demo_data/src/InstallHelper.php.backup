<?php

namespace Drupal\baas_platform_demo_data;

use Drupal\Core\DependencyInjection\ContainerInjectionInterface;
use Drupal\Core\Database\Connection;
use Drupal\Core\Entity\EntityTypeManagerInterface;
use Drupal\Core\Config\ConfigFactoryInterface;
use Drupal\Core\Logger\LoggerChannelFactoryInterface;
use Drupal\Core\State\StateInterface;
use Drupal\Core\Extension\ModuleHandlerInterface;
use Symfony\Component\DependencyInjection\ContainerInterface;

/**
 * Groups项目动态实体和数据导入助手
 *
 * 参照demo_umami的InstallHelper模式，专门处理BaaS动态实体的创建和数据导入
 * 保持系统用户导入逻辑不变，重点解决动态实体时序问题
 *
 * @internal
 *   This code is only for use by the BaaS Platform Demo Data module.
 */
class InstallHelper implements ContainerInjectionInterface {

  /**
   * The database connection.
   */
  protected Connection $database;

  /**
   * The logger.
   */
  protected $logger;

  /**
   * Entity type manager.
   */
  protected EntityTypeManagerInterface $entityTypeManager;

  /**
   * Config factory.
   */
  protected ConfigFactoryInterface $configFactory;

  /**
   * State service.
   */
  protected StateInterface $state;

  /**
   * Module handler.
   */
  protected ModuleHandlerInterface $moduleHandler;

  /**
   * Groups项目原始配置（保持不变）
   */
  protected array $groupsProjectConfig = [
    'tenant_id' => 'tenant_7375b0cd',
    'project_id' => 'tenant_7375b0cd_project_6888d012be80c',
    'project_name' => 'Groups Sports Activity Management',
    'entities' => ['users', 'activities', 'teams', 'positions', 'user_activities', 'system_config'],
    'table_prefix' => 'baas_00403b_',
  ];

  /**
   * 构造函数
   */
  public function __construct(
    Connection $database,
    LoggerChannelFactoryInterface $logger_factory,
    EntityTypeManagerInterface $entity_type_manager,
    ConfigFactoryInterface $config_factory,
    StateInterface $state,
    ModuleHandlerInterface $module_handler
  ) {
    $this->database = $database;
    $this->logger = $logger_factory->get('baas_platform_demo_data');
    $this->entityTypeManager = $entity_type_manager;
    $this->configFactory = $config_factory;
    $this->state = $state;
    $this->moduleHandler = $module_handler;
  }

  /**
   * {@inheritdoc}
   */
  public static function create(ContainerInterface $container) {
    return new static(
      $container->get('database'),
      $container->get('logger.factory'),
      $container->get('entity_type.manager'),
      $container->get('config.factory'),
      $container->get('state'),
      $container->get('module_handler')
    );
  }

  /**
   * 导入完整的Groups项目（推荐方法）
   *
   * 统一处理所有导入步骤，包括系统用户、配置、动态实体等
   * 比分散在两个类中更可靠和一致
   */
  public function importCompleteGroupsProject(): array {
    $this->logger->info('开始完整导入Groups项目（系统用户+动态实体+业务数据）');

    $import_results = [
      'success' => TRUE,
      'system_users_imported' => [],
      'tenant_created' => FALSE,
      'project_created' => FALSE,
      'entities_imported' => [],
      'entity_tables_created' => [],
      'entity_files_deployed' => [],
      'data_imported' => [],
      'entity_types_registered' => [],
      'user_permissions_fixed' => [],
      'errors' => [],
    ];

    try {
      // 1. 导入系统用户（包含完整的Drupal用户创建和权限）
      $import_results['system_users_imported'] = $this->importSystemUsers();

      // 2. 导入租户配置
      $import_results['tenant_created'] = $this->importTenantConfig();

      // 3. 导入项目配置
      $import_results['project_created'] = $this->importProjectConfig();

      // 4. 导入实体模板定义
      $import_results['entities_imported'] = $this->importEntityTemplates();

      // 5. 创建动态实体数据表（关键步骤）
      $import_results['entity_tables_created'] = $this->createEntityTables();

      // 6. 部署动态实体PHP类文件
      $import_results['entity_files_deployed'] = $this->deployEntityFiles();

      // 7. 注册实体类型到Drupal系统
      $import_results['entity_types_registered'] = $this->registerEntityTypesWithDrupal();

      // 8. 导入业务实体数据
      $import_results['data_imported'] = $this->importBusinessData();

      // 9. 设置用户权限和租户映射
      $import_results['user_permissions_fixed'] = $this->setupUserPermissionsAndMappings();

      // 10. 验证完整导入结果
      $validation = $this->validateCompleteImport();
      if (!$validation['valid']) {
        $import_results['errors'] = array_merge($import_results['errors'], $validation['issues']);
        $this->logger->warning('Groups完整导入验证发现问题: @issues', [
          '@issues' => implode(', ', $validation['issues'])
        ]);
      }

      $this->logger->info('Groups项目完整导入成功');

    } catch (\Exception $e) {
      $import_results['success'] = FALSE;
      $import_results['errors'][] = $e->getMessage();
      $this->logger->error('Groups项目完整导入失败: @error', ['@error' => $e->getMessage()]);
    }

    return $import_results;
  }

  /**
   * 导入系统用户和权限映射（从GroupsStaticDataImporter移植过来）
   */
  protected function importSystemUsers(): array {
    $imported_users = [];

    // 从静态数据文件读取系统用户数据
    $static_data_path = DRUPAL_ROOT . '/profiles/baas_platform/data/groups_static_data.json';
    $static_data = json_decode(file_get_contents($static_data_path), TRUE);

    if (!isset($static_data['system_users'])) {
      $this->logger->warning('静态数据文件中缺少系统用户配置');
      return [];
    }

    $system_users = $static_data['system_users'];

    try {
      // 1. 导入 Drupal 用户
      if (isset($system_users['drupal_users'])) {
        foreach ($system_users['drupal_users'] as $user_data) {

          // 检查用户是否已存在
          $existing_user = $this->entityTypeManager
            ->getStorage('user')
            ->loadByProperties(['name' => $user_data['name']]);

          if (empty($existing_user)) {
            // 创建新用户
            $user = $this->entityTypeManager->getStorage('user')->create([
              'name' => $user_data['name'],
              'mail' => $user_data['mail'],
              'status' => $user_data['status'],
              'timezone' => $user_data['timezone'],
              'created' => $user_data['created'],
              'changed' => $user_data['changed'],
              'access' => $user_data['access'],
              'login' => $user_data['login'],
              'init' => $user_data['init'],
            ]);
            $user->save();

            // 直接更新密码哈希到数据库（绕过Drupal的密码验证）
            $this->database->update('users_field_data')
              ->fields(['pass' => $user_data['pass']])
              ->condition('uid', $user->id())
              ->execute();

            $imported_users['drupal_users'][] = $user_data['name'];
            $this->logger->info('系统用户导入成功: @user (UID: @uid)', [
              '@user' => $user_data['name'],
              '@uid' => $user->id()
            ]);
          } else {
            $this->logger->info('系统用户已存在，跳过: @user', ['@user' => $user_data['name']]);
          }
        }
      }

      // 2. 导入用户角色关联
      if (isset($system_users['user_roles'])) {
        foreach ($system_users['user_roles'] as $role_data) {
          // 检查是否已存在相同的角色关联
          $existing_role = $this->database->select('user__roles', 'ur')
            ->condition('entity_id', $role_data['entity_id'])
            ->condition('deleted', $role_data['deleted'])
            ->condition('delta', $role_data['delta'])
            ->condition('langcode', $role_data['langcode'])
            ->condition('roles_target_id', $role_data['roles_target_id'])
            ->countQuery()
            ->execute()
            ->fetchField();

          if (!$existing_role) {
            // 直接插入到 user__roles 表
            $this->database->insert('user__roles')
              ->fields([
                'bundle' => $role_data['bundle'],
                'deleted' => $role_data['deleted'],
                'entity_id' => $role_data['entity_id'],
                'revision_id' => $role_data['revision_id'],
                'langcode' => $role_data['langcode'],
                'delta' => $role_data['delta'],
                'roles_target_id' => $role_data['roles_target_id'],
              ])
              ->execute();
          }
        }

        $imported_users['user_roles'] = count($system_users['user_roles']);
        $this->logger->info('用户角色关联导入成功: @count 条', ['@count' => count($system_users['user_roles'])]);
      }

      // 3. 导入用户-租户映射
      if (isset($system_users['user_tenant_mapping'])) {
        foreach ($system_users['user_tenant_mapping'] as $mapping_data) {
          // 确保表存在
          if ($this->database->schema()->tableExists('baas_user_tenant_mapping')) {
            // 检查是否已存在
            $existing_mapping = $this->database->select('baas_user_tenant_mapping', 'butm')
              ->condition('user_id', $mapping_data['user_id'])
              ->condition('tenant_id', $mapping_data['tenant_id'])
              ->countQuery()
              ->execute()
              ->fetchField();

            if (!$existing_mapping) {
              $this->database->insert('baas_user_tenant_mapping')
                ->fields([
                  'user_id' => $mapping_data['user_id'],
                  'tenant_id' => $mapping_data['tenant_id'],
                  'role' => $mapping_data['role'],
                  'status' => $mapping_data['status'],
                ])
                ->execute();
            }
          }
        }

        $imported_users['user_tenant_mapping'] = count($system_users['user_tenant_mapping']);
        $this->logger->info('用户-租户映射导入成功: @count 条', ['@count' => count($system_users['user_tenant_mapping'])]);
      }

      // 4. 导入项目成员关系
      if (isset($system_users['project_members'])) {
        foreach ($system_users['project_members'] as $member_data) {
          // 确保表存在
          if ($this->database->schema()->tableExists('baas_project_members')) {
            // 检查项目成员关系是否已存在
            $existing_member = $this->database->select('baas_project_members', 'bpm')
              ->condition('project_id', $member_data['project_id'])
              ->condition('user_id', $member_data['user_id'])
              ->countQuery()
              ->execute()
              ->fetchField();

            if (!$existing_member) {
              $current_time = time();

              $this->database->insert('baas_project_members')
                ->fields([
                  'project_id' => $member_data['project_id'],
                  'user_id' => $member_data['user_id'],
                  'role' => $member_data['role'],
                  'permissions' => $member_data['permissions'],
                  'status' => $member_data['status'],
                  'joined_at' => $current_time,
                  'updated_at' => $current_time,
                ])
                ->execute();
            }
          }
        }

        $imported_users['project_members'] = count($system_users['project_members']);
        $this->logger->info('项目成员关系导入成功: @count 条', ['@count' => count($system_users['project_members'])]);
      }

    } catch (\Exception $e) {
      $this->logger->error('系统用户导入失败: @error', ['@error' => $e->getMessage()]);
      throw $e; // 重新抛出异常，确保导入流程停止
    }

    return $imported_users;
  }

  /**
   * 设置用户权限和租户映射（整合原有逻辑）
   */
  protected function setupUserPermissionsAndMappings(): array {
    $fixed_users = [];
    $user_storage = $this->entityTypeManager->getStorage('user');

    try {
      // 修复admin用户权限
      $admin_users = $user_storage->loadByProperties(['name' => 'admin']);
      $admin_user = !empty($admin_users) ? reset($admin_users) : NULL;
      if ($admin_user) {
        $admin_user->addRole('administrator');
        $admin_user->addRole('tenant_admin');
        $admin_user->save();
        $fixed_users['admin'] = $admin_user->id();
        $this->logger->info('修复admin用户权限 (UID: @uid)', ['@uid' => $admin_user->id()]);
      }

      // 修复user1权限
      $user1_users = $user_storage->loadByProperties(['name' => 'user1']);
      $user1 = !empty($user1_users) ? reset($user1_users) : NULL;
      if ($user1) {
        $user1->addRole('project_manager');
        $user1->addRole('tenant_admin');
        $user1->save();
        $fixed_users['user1'] = $user1->id();
        $this->logger->info('修复user1权限 (UID: @uid)', ['@uid' => $user1->id()]);
      }

      // 修复user2权限
      $user2_users = $user_storage->loadByProperties(['name' => 'user2']);
      $user2 = !empty($user2_users) ? reset($user2_users) : NULL;
      if ($user2) {
        $user2->addRole('project_editor');
        $user2->addRole('api_developer');
        $user2->save();
        $fixed_users['user2'] = $user2->id();
        $this->logger->info('修复user2权限 (UID: @uid)', ['@uid' => $user2->id()]);
      }

      // 确保租户映射存在
      if ($this->moduleHandler->moduleExists('baas_tenant')) {
        $tenant_mapping_service = \Drupal::service('baas_auth.user_tenant_mapping');

        $system_users = [$admin_user, $user1, $user2];
        foreach ($system_users as $user) {
          if ($user) {
            try {
              $tenant_mapping_service->addUserToTenant($user->id(), 'tenant_7375b0cd');
            } catch (\Exception $e) {
              // 用户可能已经映射，这是正常的
              $this->logger->debug('租户映射用户 @user: @error', [
                '@user' => $user->getAccountName(),
                '@error' => $e->getMessage(),
              ]);
            }
          }
        }
      }

      // 设置项目成员关系
      if ($this->moduleHandler->moduleExists('baas_project')) {
        $project_member_service = \Drupal::service('baas_project.member_manager');

        try {
          // user1作为项目所有者
          if ($user1) {
            $project_member_service->addMember('tenant_7375b0cd_project_6888d012be80c', $user1->id(), 'owner', [
              'permissions' => ['manage_entities', 'manage_data', 'manage_members', 'manage_project'],
            ]);
          }

          // user2作为项目编辑者
          if ($user2) {
            $project_member_service->addMember('tenant_7375b0cd_project_6888d012be80c', $user2->id(), 'editor', [
              'permissions' => ['manage_entities', 'manage_data'],
            ]);
          }

        } catch (\Exception $e) {
          $this->logger->warning('项目成员关系设置失败: @error', [
            '@error' => $e->getMessage(),
          ]);
        }
      }

      $this->logger->info('用户权限和映射设置完成');

    } catch (\Exception $e) {
      $this->logger->error('用户权限设置失败: @error', ['@error' => $e->getMessage()]);
    }

    return $fixed_users;
  }

  /**
   * 验证完整导入结果
   */
  protected function validateCompleteImport(): array {
    $validation_results = [
      'valid' => TRUE,
      'checks' => [],
      'issues' => [],
    ];

    // 检查系统用户
    try {
      $system_users = ['admin', 'user1', 'user2'];
      foreach ($system_users as $username) {
        $users = $this->entityTypeManager->getStorage('user')->loadByProperties(['name' => $username]);
        $user_exists = !empty($users);
        $validation_results['checks'][$username . '_exists'] = $user_exists;

        if (!$user_exists) {
          $validation_results['valid'] = FALSE;
          $validation_results['issues'][] = "系统用户不存在: {$username}";
        }
      }
    } catch (\Exception $e) {
      $validation_results['issues'][] = "系统用户检查失败: {$e->getMessage()}";
    }

    // 检查租户是否存在
    try {
      $tenant_exists = $this->database->select('baas_tenant_config', 't')
        ->condition('tenant_id', $this->groupsProjectConfig['tenant_id'])
        ->countQuery()
        ->execute()
        ->fetchField() > 0;

      $validation_results['checks']['tenant_exists'] = $tenant_exists;
      if (!$tenant_exists) {
        $validation_results['valid'] = FALSE;
        $validation_results['issues'][] = '租户配置未找到';
      }
    } catch (\Exception $e) {
      $validation_results['issues'][] = "租户检查失败: {$e->getMessage()}";
    }

    // 检查项目是否存在
    try {
      $project_exists = $this->database->select('baas_project_config', 'p')
        ->condition('project_id', $this->groupsProjectConfig['project_id'])
        ->countQuery()
        ->execute()
        ->fetchField() > 0;

      $validation_results['checks']['project_exists'] = $project_exists;
      if (!$project_exists) {
        $validation_results['valid'] = FALSE;
        $validation_results['issues'][] = '项目配置未找到';
      }
    } catch (\Exception $e) {
      $validation_results['issues'][] = "项目检查失败: {$e->getMessage()}";
    }

    // 检查数据表和数据
    foreach ($this->groupsProjectConfig['entities'] as $entity_name) {
      $table_name = $this->groupsProjectConfig['table_prefix'] . $entity_name;

      try {
        $table_exists = $this->database->schema()->tableExists($table_name);
        $validation_results['checks'][$entity_name . '_table_exists'] = $table_exists;

        if ($table_exists) {
          $record_count = $this->database->select($table_name)
            ->condition('is_demo', TRUE)
            ->countQuery()
            ->execute()
            ->fetchField();

          $validation_results['checks'][$entity_name . '_demo_records'] = $record_count;
        } else {
          $validation_results['valid'] = FALSE;
          $validation_results['issues'][] = "数据表不存在: {$table_name}";
        }
      } catch (\Exception $e) {
        $validation_results['issues'][] = "数据表检查失败 {$table_name}: {$e->getMessage()}";
      }
    }

    return $validation_results;
  }

  /**
   * 专门导入动态实体（不包括系统用户和基础配置）
   *
   * 与原有GroupsStaticDataImporter配合使用，只处理动态实体表创建和数据导入
   * @deprecated 推荐使用 importCompleteGroupsProject() 方法
   */
  public function importDynamicEntitiesOnly(): array {
    $this->logger->info('开始导入动态实体和业务数据（跳过系统用户和基础配置）');

    $import_results = [
      'success' => TRUE,
      'entity_tables_created' => [],
      'entity_files_deployed' => [],
      'data_imported' => [],
      'entity_types_registered' => [],
      'errors' => [],
    ];

    try {
      // 1. 创建动态实体数据表（关键步骤）
      $import_results['entity_tables_created'] = $this->createEntityTables();

      // 2. 部署动态实体PHP类文件
      $import_results['entity_files_deployed'] = $this->deployEntityFiles();

      // 3. 注册实体类型到Drupal系统
      $import_results['entity_types_registered'] = $this->registerEntityTypesWithDrupal();

      // 4. 导入业务实体数据
      $import_results['data_imported'] = $this->importBusinessData();

      // 5. 验证导入结果
      $validation = $this->validateDynamicEntitiesImport();
      if (!$validation['valid']) {
        $import_results['errors'] = array_merge($import_results['errors'], $validation['issues']);
        $this->logger->warning('动态实体导入验证发现问题: @issues', [
          '@issues' => implode(', ', $validation['issues'])
        ]);
      }

      $this->logger->info('动态实体导入完成');

    } catch (\Exception $e) {
      $import_results['success'] = FALSE;
      $import_results['errors'][] = $e->getMessage();
      $this->logger->error('动态实体导入失败: @error', ['@error' => $e->getMessage()]);
    }

    return $import_results;
  }

  /**
   * 导入Groups项目完整数据（保持系统用户导入逻辑不变）
   *
   * 重点处理动态实体创建和业务数据导入的时序问题
   */
  public function importGroupsContent(): array {
    $this->logger->info('开始导入Groups项目内容（动态实体和业务数据）');

    $import_results = [
      'success' => TRUE,
      'tenant_created' => FALSE,
      'project_created' => FALSE,
      'entities_imported' => [],
      'entity_tables_created' => [],
      'entity_files_deployed' => [],
      'data_imported' => [],
      'entity_types_registered' => [],
      'errors' => [],
    ];

    try {
      // 1. 检查并导入租户配置
      $import_results['tenant_created'] = $this->importTenantConfig();

      // 2. 检查并导入项目配置
      $import_results['project_created'] = $this->importProjectConfig();

      // 3. 导入实体模板定义
      $import_results['entities_imported'] = $this->importEntityTemplates();

      // 4. 创建动态实体数据表（关键步骤）
      $import_results['entity_tables_created'] = $this->createEntityTables();

      // 5. 部署动态实体PHP类文件
      $import_results['entity_files_deployed'] = $this->deployEntityFiles();

      // 6. 注册实体类型到Drupal系统
      $import_results['entity_types_registered'] = $this->registerEntityTypesWithDrupal();

      // 7. 导入业务实体数据
      $import_results['data_imported'] = $this->importBusinessData();

      // 8. 验证导入结果
      $validation = $this->validateImport();
      if (!$validation['valid']) {
        $import_results['errors'] = array_merge($import_results['errors'], $validation['issues']);
        $this->logger->warning('Groups数据导入验证发现问题: @issues', [
          '@issues' => implode(', ', $validation['issues'])
        ]);
      }

      $this->logger->info('Groups项目内容导入完成');

    } catch (\Exception $e) {
      $import_results['success'] = FALSE;
      $import_results['errors'][] = $e->getMessage();
      $this->logger->error('Groups项目内容导入失败: @error', ['@error' => $e->getMessage()]);
    }

    return $import_results;
  }

  /**
   * 导入租户配置（如果不存在）
   */
  protected function importTenantConfig(): bool {
    if (!$this->moduleHandler->moduleExists('baas_tenant')) {
      $this->logger->warning('baas_tenant模块未启用，跳过租户配置导入');
      return FALSE;
    }

    try {
      // 检查租户是否已存在
      $existing_tenant = $this->database->select('baas_tenant_config', 'btc')
        ->condition('tenant_id', $this->groupsProjectConfig['tenant_id'])
        ->countQuery()
        ->execute()
        ->fetchField();

      if ($existing_tenant) {
        $this->logger->info('租户配置已存在: @tenant_id', [
          '@tenant_id' => $this->groupsProjectConfig['tenant_id']
        ]);
        return TRUE;
      }

      // 从静态数据文件读取租户配置
      $static_data_path = DRUPAL_ROOT . '/profiles/baas_platform/data/groups_static_data.json';
      if (!file_exists($static_data_path)) {
        throw new \Exception('静态数据文件不存在: ' . $static_data_path);
      }

      $static_data = json_decode(file_get_contents($static_data_path), TRUE);

      if (!isset($static_data['baas_config']['tenant_config'])) {
        throw new \Exception('静态数据文件中缺少租户配置');
      }

      foreach ($static_data['baas_config']['tenant_config'] as $tenant_data) {
        if ($tenant_data['tenant_id'] === $this->groupsProjectConfig['tenant_id']) {
          // 查找租户所有者（从系统用户映射中获取）
          $owner_uid = 2; // 默认使用 admin
          if (isset($static_data['system_users']['user_tenant_mapping'])) {
            foreach ($static_data['system_users']['user_tenant_mapping'] as $mapping) {
              if ($mapping['tenant_id'] === $tenant_data['tenant_id'] && $mapping['role'] === 'tenant_owner') {
                $owner_uid = $mapping['user_id'];
                break;
              }
            }
          }

          // 插入租户配置
          $this->database->insert('baas_tenant_config')
            ->fields([
              'tenant_id' => $tenant_data['tenant_id'],
              'name' => $tenant_data['name'],
              'owner_uid' => $owner_uid,
              'organization_type' => $tenant_data['organization_type'],
              'contact_email' => $tenant_data['contact_email'],
              'settings' => $tenant_data['settings'],
              'status' => $tenant_data['status'],
              'created' => $tenant_data['created'],
              'updated' => $tenant_data['updated'],
            ])
            ->execute();

          $this->logger->info('租户配置导入成功: @tenant_id', [
            '@tenant_id' => $tenant_data['tenant_id']
          ]);
          return TRUE;
        }
      }

      throw new \Exception('未找到目标租户配置: ' . $this->groupsProjectConfig['tenant_id']);

    } catch (\Exception $e) {
      $this->logger->error('租户配置导入失败: @error', ['@error' => $e->getMessage()]);
      return FALSE;
    }
  }

  /**
   * 导入项目配置（如果不存在）
   */
  protected function importProjectConfig(): bool {
    if (!$this->moduleHandler->moduleExists('baas_project')) {
      $this->logger->warning('baas_project模块未启用，跳过项目配置导入');
      return FALSE;
    }

    try {
      // 检查项目是否已存在
      $existing_project = $this->database->select('baas_project_config', 'bpc')
        ->condition('project_id', $this->groupsProjectConfig['project_id'])
        ->countQuery()
        ->execute()
        ->fetchField();

      if ($existing_project) {
        $this->logger->info('项目配置已存在: @project_id', [
          '@project_id' => $this->groupsProjectConfig['project_id']
        ]);
        return TRUE;
      }

      // 从静态数据文件读取项目配置
      $static_data_path = DRUPAL_ROOT . '/profiles/baas_platform/data/groups_static_data.json';
      $static_data = json_decode(file_get_contents($static_data_path), TRUE);

      if (!isset($static_data['baas_config']['project_config'])) {
        throw new \Exception('静态数据文件中缺少项目配置');
      }

      foreach ($static_data['baas_config']['project_config'] as $project_data) {
        if ($project_data['project_id'] === $this->groupsProjectConfig['project_id']) {
          // 查找项目所有者
          $owner_uid = 2; // 默认使用 admin
          if (isset($static_data['system_users']['project_members'])) {
            foreach ($static_data['system_users']['project_members'] as $member) {
              if ($member['project_id'] === $project_data['project_id'] && $member['role'] === 'owner') {
                $owner_uid = $member['user_id'];
                break;
              }
            }
          }

          // 生成机器名
          $machine_name = strtolower(str_replace([' ', '-'], '_', $project_data['name']));

          // 插入项目配置
          $this->database->insert('baas_project_config')
            ->fields([
              'project_id' => $project_data['project_id'],
              'tenant_id' => $project_data['tenant_id'],
              'name' => $project_data['name'],
              'machine_name' => $machine_name,
              'description' => $project_data['description'],
              'settings' => $project_data['settings'],
              'status' => $project_data['status'],
              'owner_uid' => $owner_uid,
              'created' => $project_data['created'],
              'updated' => $project_data['updated'],
            ])
            ->execute();

          $this->logger->info('项目配置导入成功: @project_id', [
            '@project_id' => $project_data['project_id']
          ]);
          return TRUE;
        }
      }

      throw new \Exception('未找到目标项目配置: ' . $this->groupsProjectConfig['project_id']);

    } catch (\Exception $e) {
      $this->logger->error('项目配置导入失败: @error', ['@error' => $e->getMessage()]);
      return FALSE;
    }
  }

  /**
   * 导入实体模板定义
   */
  protected function importEntityTemplates(): array {
    $imported_entities = [];

    if (!$this->moduleHandler->moduleExists('baas_entity')) {
      $this->logger->warning('baas_entity模块未启用，跳过实体模板导入');
      return [];
    }

    try {
      // 从静态数据文件读取实体模板
      $static_data_path = DRUPAL_ROOT . '/profiles/baas_platform/data/groups_static_data.json';
      $static_data = json_decode(file_get_contents($static_data_path), TRUE);

      if (!isset($static_data['baas_config']['entity_templates'])) {
        throw new \Exception('静态数据文件中缺少实体模板配置');
      }

      // 1. 导入实体模板
      foreach ($static_data['baas_config']['entity_templates'] as $template_data) {
        // 检查是否已存在
        $existing = $this->database->select('baas_entity_template', 'bet')
          ->condition('tenant_id', $template_data['tenant_id'])
          ->condition('project_id', $template_data['project_id'])
          ->condition('name', $template_data['name'])
          ->countQuery()
          ->execute()
          ->fetchField();

        if (!$existing) {
          $this->database->insert('baas_entity_template')
            ->fields([
              'tenant_id' => $template_data['tenant_id'],
              'project_id' => $template_data['project_id'],
              'name' => $template_data['name'],
              'label' => $template_data['label'],
              'description' => $template_data['description'],
              'status' => $template_data['status'],
              'settings' => $template_data['settings'],
              'created' => $template_data['created'],
              'updated' => $template_data['updated'],
            ])
            ->execute();

          $imported_entities[] = $template_data['name'];
          $this->logger->info('实体模板导入成功: @entity', ['@entity' => $template_data['name']]);
        }
      }

      // 2. 导入实体字段定义
      if (isset($static_data['baas_config']['entity_fields'])) {
        foreach ($static_data['baas_config']['entity_fields'] as $field_data) {
          // 检查是否已存在
          $existing_field = $this->database->select('baas_entity_field', 'bef')
            ->condition('template_id', $field_data['template_id'])
            ->condition('name', $field_data['name'])
            ->countQuery()
            ->execute()
            ->fetchField();

          if (!$existing_field) {
            $this->database->insert('baas_entity_field')
              ->fields([
                'template_id' => $field_data['template_id'],
                'name' => $field_data['name'],
                'label' => $field_data['label'],
                'type' => $field_data['type'],
                'required' => $field_data['required'],
                'settings' => $field_data['settings'],
                'weight' => $field_data['weight'],
                'description' => $field_data['description'],
                'created' => $field_data['created'],
                'updated' => $field_data['updated'],
              ])
              ->execute();
          }
        }
      }

      // 3. 注册实体类文件信息
      if (isset($static_data['baas_config']['entity_class_files'])) {
        // 检查表是否存在
        if ($this->database->schema()->tableExists('baas_entity_class_files')) {
          foreach ($static_data['baas_config']['entity_class_files'] as $class_data) {
            // 检查是否已存在
            $existing_class = $this->database->select('baas_entity_class_files', 'becf')
              ->condition('entity_type_id', $class_data['entity_type_id'])
              ->condition('class_type', $class_data['class_type'])
              ->countQuery()
              ->execute()
              ->fetchField();

            if (!$existing_class) {
              $this->database->insert('baas_entity_class_files')
                ->fields([
                  'entity_type_id' => $class_data['entity_type_id'],
                  'tenant_id' => $class_data['tenant_id'],
                  'class_name' => $class_data['class_name'],
                  'class_type' => $class_data['class_type'],
                  'file_path' => $class_data['file_path'],
                ])
                ->execute();
            }
          }
        }
      }

    } catch (\Exception $e) {
      $this->logger->error('实体模板导入失败: @error', ['@error' => $e->getMessage()]);
    }

    return $imported_entities;
  }

  /**
   * 创建动态实体数据表（关键步骤）
   */
  protected function createEntityTables(): array {
    $created_tables = [];

    if (!$this->moduleHandler->moduleExists('baas_entity')) {
      return [];
    }

    try {
      // 获取EntityGenerator服务
      $entity_generator = \Drupal::service('baas_entity.generator');

      foreach ($this->groupsProjectConfig['entities'] as $entity_name) {
        $table_name = $this->groupsProjectConfig['table_prefix'] . $entity_name;

        // 检查表是否已存在
        if ($this->database->schema()->tableExists($table_name)) {
          $this->logger->info('数据表已存在: @table', ['@table' => $table_name]);
          continue;
        }

        // 获取实体模板
        $template = $this->database->select('baas_entity_template', 'bet')
          ->fields('bet')
          ->condition('tenant_id', $this->groupsProjectConfig['tenant_id'])
          ->condition('project_id', $this->groupsProjectConfig['project_id'])
          ->condition('name', $entity_name)
          ->execute()
          ->fetchObject();

        if (!$template) {
          $this->logger->warning('未找到实体模板: @entity', ['@entity' => $entity_name]);
          continue;
        }

        // 使用EntityGenerator创建表
        $result = $entity_generator->createEntityTable($template);

        if ($result) {
          $created_tables[] = $table_name;
          $this->logger->info('动态实体表创建成功: @table', ['@table' => $table_name]);
        } else {
          $this->logger->error('动态实体表创建失败: @table', ['@table' => $table_name]);
        }
      }

    } catch (\Exception $e) {
      $this->logger->error('动态实体表创建过程失败: @error', ['@error' => $e->getMessage()]);
    }

    return $created_tables;
  }

  /**
   * 部署动态实体PHP类文件
   */
  protected function deployEntityFiles(): array {
    $deployed_files = [];

    // 从发行版打包的实体文件目录读取
    $static_entities_path = DRUPAL_ROOT . '/profiles/baas_platform/data/entity_files';

    if (!is_dir($static_entities_path)) {
      $this->logger->warning('静态实体文件目录不存在: @path', ['@path' => $static_entities_path]);
      return [];
    }

    // 目标部署目录
    $target_base_path = DRUPAL_ROOT . '/sites/default/files/dynamic_entities/' . $this->groupsProjectConfig['tenant_id'] . '/projects/' . $this->groupsProjectConfig['project_id'];

    // 创建基础目录
    if (!is_dir($target_base_path)) {
      mkdir($target_base_path, 0755, TRUE);
    }

    $this->logger->info('开始部署实体文件到: @path', ['@path' => $target_base_path]);

    // 递归复制整个目录结构
    $deployed_files = $this->recursiveCopyDirectory($static_entities_path, $target_base_path);

    $this->logger->info('实体文件部署完成，共部署 @count 个文件', ['@count' => count($deployed_files)]);

    // 部署上传文件
    $deployed_uploads = $this->deployUploadFiles();

    return array_merge($deployed_files, $deployed_uploads);
  }

  /**
   * 递归复制目录及其结构
   */
  protected function recursiveCopyDirectory(string $source_dir, string $target_dir): array {
    $deployed_files = [];

    if (!is_dir($source_dir)) {
      return $deployed_files;
    }

    $iterator = new \RecursiveIteratorIterator(
      new \RecursiveDirectoryIterator($source_dir, \RecursiveDirectoryIterator::SKIP_DOTS),
      \RecursiveIteratorIterator::SELF_FIRST
    );

    foreach ($iterator as $item) {
      $source_path = $item->getPathname();
      $relative_path = substr($source_path, strlen($source_dir) + 1);
      $target_path = $target_dir . '/' . $relative_path;

      if ($item->isDir()) {
        // 创建目录
        if (!is_dir($target_path)) {
          mkdir($target_path, 0755, TRUE);
        }
      } elseif ($item->isFile() && pathinfo($source_path, PATHINFO_EXTENSION) === 'php') {
        // 复制PHP文件
        $target_dir_path = dirname($target_path);
        if (!is_dir($target_dir_path)) {
          mkdir($target_dir_path, 0755, TRUE);
        }

        if (copy($source_path, $target_path)) {
          $deployed_files[] = $relative_path;
          $this->logger->info('实体文件部署成功: @file', ['@file' => $relative_path]);
        } else {
          $this->logger->error('实体文件部署失败: @file', ['@file' => $relative_path]);
        }
      }
    }

    return $deployed_files;
  }

  /**
   * 部署项目上传文件
   */
  protected function deployUploadFiles(): array {
    $deployed_files = [];

    // 从发行版打包的上传文件目录读取
    $static_uploads_path = DRUPAL_ROOT . '/profiles/baas_platform/data/uploads';

    if (!is_dir($static_uploads_path)) {
      $this->logger->info('静态上传文件目录不存在，跳过上传文件部署');
      return [];
    }

    // 目标部署目录（BaaS文件系统结构）
    $target_uploads_path = DRUPAL_ROOT . '/sites/default/files/baas/' . $this->groupsProjectConfig['tenant_id'] . '/' . $this->groupsProjectConfig['project_id'];

    if (!is_dir($target_uploads_path)) {
      mkdir($target_uploads_path, 0755, TRUE);
    }

    // 复制所有上传文件
    foreach (glob("$static_uploads_path/*") as $source_file) {
      if (is_file($source_file)) {
        $filename = basename($source_file);
        $target_file = "$target_uploads_path/$filename";

        if (copy($source_file, $target_file)) {
          $deployed_files[] = "uploads/$filename";
          $this->logger->info('上传文件部署成功: @file', ['@file' => $filename]);
        } else {
          $this->logger->error('上传文件部署失败: @file', ['@file' => $filename]);
        }
      }
    }

    return $deployed_files;
  }

  /**
   * 注册实体类型到Drupal系统
   */
  protected function registerEntityTypesWithDrupal(): array {
    $registered_types = [];

    try {
      // 获取EntityRegistry服务
      if (\Drupal::hasService('baas_entity.registry')) {
        $entity_registry = \Drupal::service('baas_entity.registry');

        // 获取所有已注册的实体类型
        $registered_entity_types = $entity_registry->getRegisteredEntityTypes();

        foreach ($this->groupsProjectConfig['entities'] as $entity_name) {
          $entity_type_id = $this->groupsProjectConfig['table_prefix'] . $entity_name;

          if (isset($registered_entity_types[$entity_type_id])) {
            $registered_types[] = $entity_type_id;
            $this->logger->info('实体类型已注册: @type', ['@type' => $entity_type_id]);
          } else {
            $this->logger->warning('实体类型未能注册: @type', ['@type' => $entity_type_id]);
          }
        }
      }

      // 清理实体类型定义缓存
      $this->entityTypeManager->clearCachedDefinitions();

      // 重建所有缓存以确保实体类型可用
      drupal_flush_all_caches();

      $this->logger->info('实体类型已注册到Drupal系统: @count 个', [
        '@count' => count($registered_types)
      ]);

    } catch (\Exception $e) {
      $this->logger->error('实体类型注册失败: @error', ['@error' => $e->getMessage()]);
    }

    return $registered_types;
  }

  /**
   * 导入业务实体数据
   */
  protected function importBusinessData(): array {
    $imported_data = [];

    // 从静态数据文件读取业务数据
    $static_data_path = DRUPAL_ROOT . '/profiles/baas_platform/data/groups_static_data.json';
    $static_data = json_decode(file_get_contents($static_data_path), TRUE);

    if (!isset($static_data['entities'])) {
      $this->logger->warning('静态数据文件中缺少业务实体数据');
      return [];
    }

    foreach ($static_data['entities'] as $entity_name => $sample_records) {
      if (empty($sample_records)) {
        continue;
      }

      $table_name = $this->groupsProjectConfig['table_prefix'] . $entity_name;

      try {
        // 检查表是否存在
        if (!$this->database->schema()->tableExists($table_name)) {
          $this->logger->warning('数据表不存在，跳过数据导入: @table', ['@table' => $table_name]);
          continue;
        }

        // 检查表中是否已有演示数据
        $existing_count = $this->database->select($table_name)
          ->condition('is_demo', TRUE)
          ->countQuery()
          ->execute()
          ->fetchField();

        if ($existing_count > 0) {
          $this->logger->info('表中已有演示数据，跳过: @table (@count 条)', [
            '@table' => $table_name,
            '@count' => $existing_count
          ]);
          continue;
        }

        // 导入数据
        $inserted_count = 0;
        foreach ($sample_records as $record) {
          // 确保使用原始租户和项目ID
          $record['tenant_id'] = $this->groupsProjectConfig['tenant_id'];
          $record['project_id'] = $this->groupsProjectConfig['project_id'];
          $record['is_demo'] = TRUE;

          $this->database->insert($table_name)->fields($record)->execute();
          $inserted_count++;
        }

        $imported_data[$entity_name] = $inserted_count;
        $this->logger->info('业务数据导入成功: @entity (@count 条记录)', [
          '@entity' => $entity_name,
          '@count' => $inserted_count
        ]);

      } catch (\Exception $e) {
        $this->logger->error('业务数据导入失败: @entity, 错误: @error', [
          '@entity' => $entity_name,
          '@error' => $e->getMessage()
        ]);
      }
    }

    return $imported_data;
  }

  /**
   * 验证导入结果
   */
  public function validateImport(): array {
    $validation_results = [
      'valid' => TRUE,
      'checks' => [],
      'issues' => [],
    ];

    // 检查租户是否存在
    try {
      $tenant_exists = $this->database->select('baas_tenant_config', 't')
        ->condition('tenant_id', $this->groupsProjectConfig['tenant_id'])
        ->countQuery()
        ->execute()
        ->fetchField() > 0;

      $validation_results['checks']['tenant_exists'] = $tenant_exists;
      if (!$tenant_exists) {
        $validation_results['valid'] = FALSE;
        $validation_results['issues'][] = '租户配置未找到';
      }
    } catch (\Exception $e) {
      $validation_results['issues'][] = "租户检查失败: {$e->getMessage()}";
    }

    // 检查项目是否存在
    try {
      $project_exists = $this->database->select('baas_project_config', 'p')
        ->condition('project_id', $this->groupsProjectConfig['project_id'])
        ->countQuery()
        ->execute()
        ->fetchField() > 0;

      $validation_results['checks']['project_exists'] = $project_exists;
      if (!$project_exists) {
        $validation_results['valid'] = FALSE;
        $validation_results['issues'][] = '项目配置未找到';
      }
    } catch (\Exception $e) {
      $validation_results['issues'][] = "项目检查失败: {$e->getMessage()}";
    }

    // 检查数据表和数据
    foreach ($this->groupsProjectConfig['entities'] as $entity_name) {
      $table_name = $this->groupsProjectConfig['table_prefix'] . $entity_name;

      try {
        $table_exists = $this->database->schema()->tableExists($table_name);
        $validation_results['checks'][$entity_name . '_table_exists'] = $table_exists;

        if ($table_exists) {
          $record_count = $this->database->select($table_name)
            ->condition('is_demo', TRUE)
            ->countQuery()
            ->execute()
            ->fetchField();

          $validation_results['checks'][$entity_name . '_demo_records'] = $record_count;
        } else {
          $validation_results['valid'] = FALSE;
          $validation_results['issues'][] = "数据表不存在: {$table_name}";
        }
      } catch (\Exception $e) {
        $validation_results['issues'][] = "数据表检查失败 {$table_name}: {$e->getMessage()}";
      }
    }

    return $validation_results;
  }

  /**
   * 验证动态实体导入结果（不检查租户和项目配置）
   */
  protected function validateDynamicEntitiesImport(): array {
    $validation_results = [
      'valid' => TRUE,
      'checks' => [],
      'issues' => [],
    ];

    // 检查数据表和数据
    foreach ($this->groupsProjectConfig['entities'] as $entity_name) {
      $table_name = $this->groupsProjectConfig['table_prefix'] . $entity_name;

      try {
        $table_exists = $this->database->schema()->tableExists($table_name);
        $validation_results['checks'][$entity_name . '_table_exists'] = $table_exists;

        if ($table_exists) {
          $record_count = $this->database->select($table_name)
            ->condition('is_demo', TRUE)
            ->countQuery()
            ->execute()
            ->fetchField();

          $validation_results['checks'][$entity_name . '_demo_records'] = $record_count;
        } else {
          $validation_results['valid'] = FALSE;
          $validation_results['issues'][] = "数据表不存在: {$table_name}";
        }
      } catch (\Exception $e) {
        $validation_results['issues'][] = "数据表检查失败 {$table_name}: {$e->getMessage()}";
      }
    }

    return $validation_results;
  }

  /**
   * 删除所有导入的内容（用于模块卸载）
   */
  public function deleteImportedContent(): void {
    try {
      // 删除业务数据
      foreach ($this->groupsProjectConfig['entities'] as $entity_name) {
        $table_name = $this->groupsProjectConfig['table_prefix'] . $entity_name;

        if ($this->database->schema()->tableExists($table_name)) {
          $this->database->delete($table_name)
            ->condition('is_demo', TRUE)
            ->execute();
        }
      }

      // 删除实体模板和字段定义
      if ($this->database->schema()->tableExists('baas_entity_template')) {
        $this->database->delete('baas_entity_template')
          ->condition('tenant_id', $this->groupsProjectConfig['tenant_id'])
          ->condition('project_id', $this->groupsProjectConfig['project_id'])
          ->execute();
      }

      // 删除项目配置
      if ($this->database->schema()->tableExists('baas_project_config')) {
        $this->database->delete('baas_project_config')
          ->condition('project_id', $this->groupsProjectConfig['project_id'])
          ->execute();
      }

      // 删除租户配置
      if ($this->database->schema()->tableExists('baas_tenant_config')) {
        $this->database->delete('baas_tenant_config')
          ->condition('tenant_id', $this->groupsProjectConfig['tenant_id'])
          ->execute();
      }

      $this->logger->info('已删除所有导入的Groups项目内容');

    } catch (\Exception $e) {
      $this->logger->error('删除导入内容失败: @error', ['@error' => $e->getMessage()]);
    }
  }
}
    $static_data = json_decode(file_get_contents($static_data_path), TRUE);

    if (!isset($static_data['system_users'])) {
      $this->logger->warning('静态数据文件中缺少系统用户配置');
      return [];
    }

    $system_users = $static_data['system_users'];

    try {
      // 1. 导入 Drupal 用户
      if (isset($system_users['drupal_users'])) {
        foreach ($system_users['drupal_users'] as $user_data) {

          // 检查用户是否已存在
          $existing_user = $this->entityTypeManager
            ->getStorage('user')
            ->loadByProperties(['name' => $user_data['name']]);

          if (empty($existing_user)) {
            // 创建新用户
            $user = $this->entityTypeManager->getStorage('user')->create([
              'name' => $user_data['name'],
              'mail' => $user_data['mail'],
              'status' => $user_data['status'],
              'timezone' => $user_data['timezone'],
              'created' => $user_data['created'],
              'changed' => $user_data['changed'],
              'access' => $user_data['access'],
              'login' => $user_data['login'],
              'init' => $user_data['init'],
            ]);
            $user->save();

            // 直接更新密码哈希到数据库（绕过Drupal的密码验证）
            $this->database->update('users_field_data')
              ->fields(['pass' => $user_data['pass']])
              ->condition('uid', $user->id())
              ->execute();

            $imported_users['drupal_users'][] = $user_data['name'];
            $this->logger->info('系统用户导入成功: @user (UID: @uid)', [
              '@user' => $user_data['name'],
              '@uid' => $user->id()
            ]);
          } else {
            $this->logger->info('系统用户已存在，跳过: @user', ['@user' => $user_data['name']]);
          }
        }
      }

      // 2. 导入用户角色关联
      if (isset($system_users['user_roles'])) {
        foreach ($system_users['user_roles'] as $role_data) {
          // 检查是否已存在相同的角色关联
          $existing_role = $this->database->select('user__roles', 'ur')
            ->condition('entity_id', $role_data['entity_id'])
            ->condition('deleted', $role_data['deleted'])
            ->condition('delta', $role_data['delta'])
            ->condition('langcode', $role_data['langcode'])
            ->condition('roles_target_id', $role_data['roles_target_id'])
            ->countQuery()
            ->execute()
            ->fetchField();

          if (!$existing_role) {
            // 直接插入到 user__roles 表
            $this->database->insert('user__roles')
              ->fields([
                'bundle' => $role_data['bundle'],
                'deleted' => $role_data['deleted'],
                'entity_id' => $role_data['entity_id'],
                'revision_id' => $role_data['revision_id'],
                'langcode' => $role_data['langcode'],
                'delta' => $role_data['delta'],
                'roles_target_id' => $role_data['roles_target_id'],
              ])
              ->execute();
          }
        }

        $imported_users['user_roles'] = count($system_users['user_roles']);
        $this->logger->info('用户角色关联导入成功: @count 条', ['@count' => count($system_users['user_roles'])]);
      }

      // 3. 导入用户-租户映射
      if (isset($system_users['user_tenant_mapping'])) {
        foreach ($system_users['user_tenant_mapping'] as $mapping_data) {
          // 确保表存在
          if ($this->database->schema()->tableExists('baas_user_tenant_mapping')) {
            // 检查是否已存在
            $existing_mapping = $this->database->select('baas_user_tenant_mapping', 'butm')
              ->condition('user_id', $mapping_data['user_id'])
              ->condition('tenant_id', $mapping_data['tenant_id'])
              ->countQuery()
              ->execute()
              ->fetchField();

            if (!$existing_mapping) {
              $this->database->insert('baas_user_tenant_mapping')
                ->fields([
                  'user_id' => $mapping_data['user_id'],
                  'tenant_id' => $mapping_data['tenant_id'],
                  'role' => $mapping_data['role'],
                  'status' => $mapping_data['status'],
                ])
                ->execute();
            }
          }
        }

        $imported_users['user_tenant_mapping'] = count($system_users['user_tenant_mapping']);
        $this->logger->info('用户-租户映射导入成功: @count 条', ['@count' => count($system_users['user_tenant_mapping'])]);
      }

      // 4. 导入项目成员关系
      if (isset($system_users['project_members'])) {
        foreach ($system_users['project_members'] as $member_data) {
          // 确保表存在
          if ($this->database->schema()->tableExists('baas_project_members')) {
            // 检查项目成员关系是否已存在
            $existing_member = $this->database->select('baas_project_members', 'bpm')
              ->condition('project_id', $member_data['project_id'])
              ->condition('user_id', $member_data['user_id'])
              ->countQuery()
              ->execute()
              ->fetchField();

            if (!$existing_member) {
              $current_time = time();

              $this->database->insert('baas_project_members')
                ->fields([
                  'project_id' => $member_data['project_id'],
                  'user_id' => $member_data['user_id'],
                  'role' => $member_data['role'],
                  'permissions' => $member_data['permissions'],
                  'status' => $member_data['status'],
                  'joined_at' => $current_time,
                  'updated_at' => $current_time,
                ])
                ->execute();
            }
          }
        }

        $imported_users['project_members'] = count($system_users['project_members']);
        $this->logger->info('项目成员关系导入成功: @count 条', ['@count' => count($system_users['project_members'])]);
      }

    } catch (\Exception $e) {
      $this->logger->error('系统用户导入失败: @error', ['@error' => $e->getMessage()]);
      throw $e; // 重新抛出异常，确保导入流程停止
    }

    return $imported_users;
  }

  /**
   * 设置用户权限和租户映射（整合原有逻辑）
   */
  protected function setupUserPermissionsAndMappings(): array {
    $fixed_users = [];
    $user_storage = $this->entityTypeManager->getStorage('user');

    try {
      // 修复admin用户权限
      $admin_users = $user_storage->loadByProperties(['name' => 'admin']);
      $admin_user = !empty($admin_users) ? reset($admin_users) : NULL;
      if ($admin_user) {
        $admin_user->addRole('administrator');
        $admin_user->addRole('tenant_admin');
        $admin_user->save();
        $fixed_users['admin'] = $admin_user->id();
        $this->logger->info('修复admin用户权限 (UID: @uid)', ['@uid' => $admin_user->id()]);
      }

      // 修复user1权限
      $user1_users = $user_storage->loadByProperties(['name' => 'user1']);
      $user1 = !empty($user1_users) ? reset($user1_users) : NULL;
      if ($user1) {
        $user1->addRole('project_manager');
        $user1->addRole('tenant_admin');
        $user1->save();
        $fixed_users['user1'] = $user1->id();
        $this->logger->info('修复user1权限 (UID: @uid)', ['@uid' => $user1->id()]);
      }

      // 修复user2权限
      $user2_users = $user_storage->loadByProperties(['name' => 'user2']);
      $user2 = !empty($user2_users) ? reset($user2_users) : NULL;
      if ($user2) {
        $user2->addRole('project_editor');
        $user2->addRole('api_developer');
        $user2->save();
        $fixed_users['user2'] = $user2->id();
        $this->logger->info('修复user2权限 (UID: @uid)', ['@uid' => $user2->id()]);
      }

      // 确保租户映射存在
      if ($this->moduleHandler->moduleExists('baas_tenant')) {
        $tenant_mapping_service = \Drupal::service('baas_auth.user_tenant_mapping');

        $system_users = [$admin_user, $user1, $user2];
        foreach ($system_users as $user) {
          if ($user) {
            try {
              $tenant_mapping_service->addUserToTenant($user->id(), 'tenant_7375b0cd');
            } catch (\Exception $e) {
              // 用户可能已经映射，这是正常的
              $this->logger->debug('租户映射用户 @user: @error', [
                '@user' => $user->getAccountName(),
                '@error' => $e->getMessage(),
              ]);
            }
          }
        }
      }

      // 设置项目成员关系
      if ($this->moduleHandler->moduleExists('baas_project')) {
        $project_member_service = \Drupal::service('baas_project.member_manager');

        try {
          // user1作为项目所有者
          if ($user1) {
            $project_member_service->addMember('tenant_7375b0cd_project_6888d012be80c', $user1->id(), 'owner', [
              'permissions' => ['manage_entities', 'manage_data', 'manage_members', 'manage_project'],
            ]);
          }

          // user2作为项目编辑者
          if ($user2) {
            $project_member_service->addMember('tenant_7375b0cd_project_6888d012be80c', $user2->id(), 'editor', [
              'permissions' => ['manage_entities', 'manage_data'],
            ]);
          }

        } catch (\Exception $e) {
          $this->logger->warning('项目成员关系设置失败: @error', [
            '@error' => $e->getMessage(),
          ]);
        }
      }

      $this->logger->info('用户权限和映射设置完成');

    } catch (\Exception $e) {
      $this->logger->error('用户权限设置失败: @error', ['@error' => $e->getMessage()]);
    }

    return $fixed_users;
  }

  /**
   * 验证完整导入结果
   */
  protected function validateCompleteImport(): array {
    $validation_results = [
      'valid' => TRUE,
      'checks' => [],
      'issues' => [],
    ];

    // 检查系统用户
    try {
      $system_users = ['admin', 'user1', 'user2'];
      foreach ($system_users as $username) {
        $users = $this->entityTypeManager->getStorage('user')->loadByProperties(['name' => $username]);
        $user_exists = !empty($users);
        $validation_results['checks'][$username . '_exists'] = $user_exists;

        if (!$user_exists) {
          $validation_results['valid'] = FALSE;
          $validation_results['issues'][] = "系统用户不存在: {$username}";
        }
      }
    } catch (\Exception $e) {
      $validation_results['issues'][] = "系统用户检查失败: {$e->getMessage()}";
    }

    // 检查租户是否存在
    try {
      $tenant_exists = $this->database->select('baas_tenant_config', 't')
        ->condition('tenant_id', $this->groupsProjectConfig['tenant_id'])
        ->countQuery()
        ->execute()
        ->fetchField() > 0;

      $validation_results['checks']['tenant_exists'] = $tenant_exists;
      if (!$tenant_exists) {
        $validation_results['valid'] = FALSE;
        $validation_results['issues'][] = '租户配置未找到';
      }
    } catch (\Exception $e) {
      $validation_results['issues'][] = "租户检查失败: {$e->getMessage()}";
    }

    // 检查项目是否存在
    try {
      $project_exists = $this->database->select('baas_project_config', 'p')
        ->condition('project_id', $this->groupsProjectConfig['project_id'])
        ->countQuery()
        ->execute()
        ->fetchField() > 0;

      $validation_results['checks']['project_exists'] = $project_exists;
      if (!$project_exists) {
        $validation_results['valid'] = FALSE;
        $validation_results['issues'][] = '项目配置未找到';
      }
    } catch (\Exception $e) {
      $validation_results['issues'][] = "项目检查失败: {$e->getMessage()}";
    }

    // 检查数据表和数据
    foreach ($this->groupsProjectConfig['entities'] as $entity_name) {
      $table_name = $this->groupsProjectConfig['table_prefix'] . $entity_name;

      try {
        $table_exists = $this->database->schema()->tableExists($table_name);
        $validation_results['checks'][$entity_name . '_table_exists'] = $table_exists;

        if ($table_exists) {
          $record_count = $this->database->select($table_name)
            ->condition('is_demo', TRUE)
            ->countQuery()
            ->execute()
            ->fetchField();

          $validation_results['checks'][$entity_name . '_demo_records'] = $record_count;
        } else {
          $validation_results['valid'] = FALSE;
          $validation_results['issues'][] = "数据表不存在: {$table_name}";
        }
      } catch (\Exception $e) {
        $validation_results['issues'][] = "数据表检查失败 {$table_name}: {$e->getMessage()}";
      }
    }

    return $validation_results;
  }

  /**
   * 删除所有导入的内容（用于模块卸载）
   */
  public function deleteImportedContent(): void {
    try {
      // 删除业务数据
      foreach ($this->groupsProjectConfig['entities'] as $entity_name) {
        $table_name = $this->groupsProjectConfig['table_prefix'] . $entity_name;

        if ($this->database->schema()->tableExists($table_name)) {
          $this->database->delete($table_name)
            ->condition('is_demo', TRUE)
            ->execute();
        }
      }

      // 删除实体模板和字段定义
      if ($this->database->schema()->tableExists('baas_entity_template')) {
        $this->database->delete('baas_entity_template')
          ->condition('tenant_id', $this->groupsProjectConfig['tenant_id'])
          ->condition('project_id', $this->groupsProjectConfig['project_id'])
          ->execute();
      }

      // 删除项目配置
      if ($this->database->schema()->tableExists('baas_project_config')) {
        $this->database->delete('baas_project_config')
          ->condition('project_id', $this->groupsProjectConfig['project_id'])
          ->execute();
      }

      // 删除租户配置
      if ($this->database->schema()->tableExists('baas_tenant_config')) {
        $this->database->delete('baas_tenant_config')
          ->condition('tenant_id', $this->groupsProjectConfig['tenant_id'])
          ->execute();
      }

      $this->logger->info('已删除所有导入的Groups项目内容');

    } catch (\Exception $e) {
      $this->logger->error('删除导入内容失败: @error', ['@error' => $e->getMessage()]);
    }
  }
}